# WL#6842 - GCS APPLIER MODULE

# This test checks the basic functionality of the GCS replication
# plugin: the initialization of it's applier module and error cases.

--source include/have_debug.inc
--source include/have_gcs_replication_plugin.inc

--let $gcs_group_name= 2d249320-2e06-11e3-aa6e-0800200c9a66
--let $rpl_skip_gcs_replication_start= 1
--source include/master-slave.inc

set session sql_log_bin=0;
call mtr.add_suppression("An handler, marked as unique *.*");
call mtr.add_suppression("Cannot start the applier as a *.*");
call mtr.add_suppression("On shutdown there was a timeout on the applier *.*");
set session sql_log_bin=1;

--let $debug_save_timeout= `SELECT @@GLOBAL.gcs_replication_plugin_components_stop_timeout`

--eval SET GLOBAL gcs_replication_plugin_group_name= "$gcs_group_name"

SET @debug_save= @@GLOBAL.DEBUG;
SET GLOBAL debug= 'd,double_unique_handler';

# This start command will error out due to the double occurrence
# of a singleton handler (applier initialization error).
--error ER_GCS_REPLICATION_APPLIER_INIT_ERROR
START GCS_REPLICATION;

SET @@GLOBAL.DEBUG= @debug_save;

#The initialization process should now go smoothly
--source include/start_gcs_replication.inc

#Set the timeout to the minimum value: 2
--eval SET GLOBAL gcs_replication_plugin_components_stop_timeout= 2

--let $assert_text= The value of stop_components_timeout should be 2
--let $assert_cond= [SELECT @@gcs_replication_plugin_components_stop_timeout] = 2
--source include/assert.inc

SET @@GLOBAL.DEBUG= 'd,applier_thd_timeout';

#The applier thread is stuck so the STOP command will timeout
--error ER_STOP_GCS_APPLIER_THREAD_TIMEOUT
STOP GCS_REPLICATION;

#The start command will fail as the applier is still running
--error ER_GCS_REPLICATION_APPLIER_INIT_ERROR
START GCS_REPLICATION;

SET DEBUG_SYNC= "now SIGNAL signal.applier_continue";
SET @@GLOBAL.DEBUG= @debug_save;

#give it time to die
--sleep 5

--eval SET GLOBAL gcs_replication_plugin_components_stop_timeout= $debug_save_timeout
#start and stop commands should work properly
--source include/start_gcs_replication.inc
--source include/stop_gcs_replication.inc

SET @@GLOBAL.DEBUG= @debug_save;
--source include/rpl_end.inc
