#
# The purpose of this test is to demonstrate the capabilities of the
# Replication Observers example plugin and to assess its correct functionality
#
# The plugin is loaded at startup in order to be able to capture Server events
#

--source include/not_embedded.inc
--source include/have_log_bin.inc
--source include/not_windows.inc
--source include/have_binlog_format_mixed.inc
--source include/have_replication_observers_example_plugin.inc

--echo #
--echo # Cause an explicit transaction in order to Trans Observer to be called
--echo #

CREATE TABLE t1 (c1 INT) Engine=InnoDB;

INSERT t1 VALUES(1);

BEGIN;
INSERT t1 VALUES(2);
ROLLBACK;

DROP TABLE t1;

--echo #
--echo # Cause an explicit restart in order to Server Observer to be called
--echo #

--source include/restart_mysqld.inc

--echo #
--echo # Verify that all Server Listening hooks were called
--echo #

--let GREP_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let GREP_PATTERN=replication_observers_example_plugin:before_handle_connection
--source extra/rpl_tests/grep_pattern.inc

--let GREP_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let GREP_PATTERN=replication_observers_example_plugin:before_recovery
--source extra/rpl_tests/grep_pattern.inc

--let GREP_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let GREP_PATTERN=replication_observers_example_plugin:after_engine_recovery
--source extra/rpl_tests/grep_pattern.inc

--let GREP_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let GREP_PATTERN=replication_observers_example_plugin:after_recovery
--source extra/rpl_tests/grep_pattern.inc

--let GREP_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let GREP_PATTERN=replication_observers_example_plugin:before_server_shutdown
--source extra/rpl_tests/grep_pattern.inc

--let GREP_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let GREP_PATTERN=replication_observers_example_plugin:after_server_shutdown
--source extra/rpl_tests/grep_pattern.inc

--echo #
--echo # Verify that all Trans Listening hooks were called
--echo #

--let GREP_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let GREP_PATTERN=replication_observers_example_plugin:trans_before_commit
--source extra/rpl_tests/grep_pattern.inc

--let GREP_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let GREP_PATTERN=replication_observers_example_plugin:trans_before_rollback
--source extra/rpl_tests/grep_pattern.inc

--let GREP_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let GREP_PATTERN=replication_observers_example_plugin:trans_after_commit
--source extra/rpl_tests/grep_pattern.inc

--let GREP_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let GREP_PATTERN=replication_observers_example_plugin:trans_after_rollback
--source extra/rpl_tests/grep_pattern.inc

--echo End of test
