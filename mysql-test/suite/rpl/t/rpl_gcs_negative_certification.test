############################################################
# Verify server behaviour when a transaction is negatively
# certified.
############################################################
--source include/have_debug.inc
--source include/have_gcs_replication_plugin.inc

--let $gcs_group_name= 8a94f357-aab4-11df-86ab-c80aa9429123

--echo ############################################################
--echo # 1. Start servers. Execute some transactions on server1.
--connection server1
RESET MASTER;
--source include/install_gcs_replication.inc
--source include/start_gcs_replication.inc

--connection server2
RESET MASTER;
--source include/install_gcs_replication.inc
--source include/start_gcs_replication.inc

--connection server1
--let $gcs_number_of_nodes= 2
--source include/rpl_gcs_wait_for_number_of_nodes.inc
CREATE TABLE t1 (c1 INT NOT NULL PRIMARY KEY) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1);
# FIXME: replace sleep with sync_slave_sql_with_master.inc
#--source include/sync_slave_sql_with_master.inc
--sleep 2

--echo
--echo ############################################################
--echo # 2. Force negative certification outcome of the next
--echo #    transaction.
--connection server1
SET @@GLOBAL.DEBUG= @debug_saved;
SET @@GLOBAL.DEBUG= '+d,gcs_force_1_negative_certification';
--connection server2
SET @@GLOBAL.DEBUG= @debug_saved;
SET @@GLOBAL.DEBUG= '+d,gcs_force_1_negative_certification';

--echo
--echo ############################################################
--echo # 3. First insert must be aborted.
--connection server1
--error ER_ERROR_DURING_COMMIT
INSERT INTO t1 VALUES (2);

INSERT INTO t1 VALUES (3);
# FIXME: replace sleep with sync_slave_sql_with_master.inc
#--source include/sync_slave_sql_with_master.inc
--sleep 2

--let $assert_text= 'There is no value 2 in table t1 on server 1'
--let $assert_cond= [SELECT COUNT(*) AS count FROM t1 WHERE t1.c1 = 2, count, 1] = 0
--source include/assert.inc
--let $assert_text= 'There is a value 3 in table t1 on server 1'
--let $assert_cond= [SELECT COUNT(*) AS count FROM t1 WHERE t1.c1 = 3, count, 1] = 1
--source include/assert.inc

--connection server2
--let $assert_text= 'There is no value 2 in table t1 on server 2'
--let $assert_cond= [SELECT COUNT(*) AS count FROM t1 WHERE t1.c1 = 2, count, 1] = 0
--source include/assert.inc
--let $assert_text= 'There is a value 3 in table t1 on server 2'
--let $assert_cond= [SELECT COUNT(*) AS count FROM t1 WHERE t1.c1 = 3, count, 1] = 1
--source include/assert.inc

--echo
--echo ############################################################
--echo # 4. Clean debug flag on MTR side.
--connection server1
SET @@GLOBAL.DEBUG= @debug_saved;
--connection server2
SET @@GLOBAL.DEBUG= @debug_saved;

--echo
--echo ############################################################
--echo # 5. Shutdown.
--connection server1
DROP TABLE t1;

# FIXME: replace with sync_slave_with_master
--sleep 2
--source include/stop_gcs_replication.inc
--source include/uninstall_gcs_replication.inc

--let $assert_text= 'Aborted transaction should not have increased GNO to 5 on server 1'
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$gcs_group_name:1-4"
--source include/assert.inc
RESET MASTER;

--connection server2
--source include/stop_gcs_replication.inc
--source include/uninstall_gcs_replication.inc

--let $assert_text= 'Aborted transaction should not have increased GNO to 5 on server 2'
--let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "$gcs_group_name:1-4"
--source include/assert.inc
RESET MASTER;
