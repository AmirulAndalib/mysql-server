#
# The intent of this test is to verify if the validations that were
# created within the GCS plugin in the startup process
# are fully functional.
#
# It will test the dynamic variables:
# - binlog_checksum. It will be set to CRC32 in order to fail.
# - binlog_format. It will be set to STATEMENT in order to fail.
#
# Since the failure will happen when "START GCS_REPLICATION" is
# issued, the test procedures are the following:
# - Install plugin
# - Backup and change the variable value
# - Call START GCS_REPLICATION and wait for it to fail
# - Restore the old value
#

--source include/have_gcs_replication_plugin.inc

--connection server1

--echo #
--echo # Test if binlog_checksum with the wrong value will fail.
--echo #

--let $binlog_checksum_backup= `SELECT @@GLOBAL.binlog_checksum;`
SET GLOBAL binlog_checksum= CRC32;

--error ER_GCS_REPLICATION_CONFIGURATION
START GCS_REPLICATION;

--eval SET GLOBAL binlog_checksum= $binlog_checksum_backup

--echo #
--echo # Test if binlog_format with the wrong value will fail.
--echo #

--let $binlog_format_backup= `SELECT @@GLOBAL.binlog_format`

SET GLOBAL binlog_format= STATEMENT;

--error ER_GCS_REPLICATION_CONFIGURATION
START GCS_REPLICATION;

--eval SET GLOBAL binlog_format= $binlog_format_backup

call mtr.add_suppression("Binlog checksum should be OFF for Group Replication");
call mtr.add_suppression("Binlog format should be ROW for Group Replication");

