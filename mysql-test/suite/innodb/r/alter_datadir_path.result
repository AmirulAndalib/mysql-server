#
#Bug #33398681 Innodb ibd tablespace file is moved back from innodb_directories to datadir after ALTER TABLE
#
# Set different paths for --datadir
# Create innodb_directories folder
# Create external datadir folder
# Create external datadir2 folder
# Restart the engine to make the external directory known.
# restart: --innodb-directories=MYSQL_TMP_DIR/external_dir;MYSQL_TMP_DIR/external_dir2
# Create table
CREATE DATABASE dbtest;
USE dbtest;
# Normal tables
CREATE TABLE `t1a` (`c1` INT);
CREATE TABLE `t1b` (`c1` INT);
CREATE TABLE `t1c` (`c1` INT);
# Normal tables with data directory clause
CREATE TABLE `t2a` (`c1` INT) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir';
CREATE TABLE `t2b` (`c1` INT) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir';
CREATE TABLE `t2c` (`c1` INT) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir';
# Partition tables
CREATE TABLE `t3a` (a INT, b INT) PARTITION BY RANGE(a) (PARTITION p0 VALUES LESS THAN (10), PARTITION p1 VALUES LESS THAN (20));
CREATE TABLE `t3b` (a INT, b INT) PARTITION BY RANGE(a) (PARTITION p0 VALUES LESS THAN (10), PARTITION p1 VALUES LESS THAN (20));
CREATE TABLE `t3c` (a INT, b INT) PARTITION BY RANGE(a) (PARTITION p0 VALUES LESS THAN (10), PARTITION p1 VALUES LESS THAN (20));
# Partition tables with data directory clause
CREATE TABLE `t4a` (a INT, b INT) PARTITION BY RANGE(a) (PARTITION p0 VALUES LESS THAN (10) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir', PARTITION p1 VALUES LESS THAN (20) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir');
CREATE TABLE `t4b` (a INT, b INT) PARTITION BY RANGE(a) (PARTITION p0 VALUES LESS THAN (10) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir', PARTITION p1 VALUES LESS THAN (20) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir');
CREATE TABLE `t4c` (a INT, b INT) PARTITION BY RANGE(a) (PARTITION p0 VALUES LESS THAN (10) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir', PARTITION p1 VALUES LESS THAN (20) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir');
# Normal tables with data directory clause 2
CREATE TABLE `t5a` (`c1` INT) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir2';
CREATE TABLE `t5b` (`c1` INT) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir2';
CREATE TABLE `t5c` (`c1` INT) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir2';
# Partition tables with data directory clause
CREATE TABLE `t6a` (a INT, b INT) PARTITION BY RANGE(a) (PARTITION p0 VALUES LESS THAN (10) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir2', PARTITION p1 VALUES LESS THAN (20) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir2');
CREATE TABLE `t6b` (a INT, b INT) PARTITION BY RANGE(a) (PARTITION p0 VALUES LESS THAN (10) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir2', PARTITION p1 VALUES LESS THAN (20) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir2');
CREATE TABLE `t6c` (a INT, b INT) PARTITION BY RANGE(a) (PARTITION p0 VALUES LESS THAN (10) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir2', PARTITION p1 VALUES LESS THAN (20) DATA DIRECTORY='MYSQL_TMP_DIR/external_dir2');
# Shutdown server
# 1. ibd files for t1a, t1b, t1c, t3a, t3b, t3c
# Check that the ibd files for each table exist in the working (dbtest) folder
t1a.ibd
t1b.ibd
t1c.ibd
t3a#p#p0.ibd
t3a#p#p1.ibd
t3b#p#p0.ibd
t3b#p#p1.ibd
t3c#p#p0.ibd
t3c#p#p1.ibd
# Move ibd files from default directory to new innodb directory
# Check that the files exist in the innodb_directories folder before alter after moving
t1a.ibd
t1b.ibd
t1c.ibd
t3a#p#p0.ibd
t3a#p#p1.ibd
t3b#p#p0.ibd
t3b#p#p1.ibd
t3c#p#p0.ibd
t3c#p#p1.ibd
# 2. ibd files for t2a, t2b, t2c, t4a, t4b, t4c
# Check that the ibd files for each table exist in the external directory where the tables are created
t2a.ibd
t2b.ibd
t2c.ibd
t4a#p#p0.ibd
t4a#p#p1.ibd
t4b#p#p0.ibd
t4b#p#p1.ibd
t4c#p#p0.ibd
t4c#p#p1.ibd
# 3. ibd files for t5a, t5b, t5c, t6a, t6b, t6c
# Check that the ibd files for each table exist in the external directory2 where the tables are created
t5a.ibd
t5b.ibd
t5c.ibd
t6a#p#p0.ibd
t6a#p#p1.ibd
t6b#p#p0.ibd
t6b#p#p1.ibd
t6c#p#p0.ibd
t6c#p#p1.ibd
# Move ibd files for t5a, t5b, t5c, t6a, t6b, t6c from external directory2 to default directory
# Check that the ibd files for t5a, t5b, t5c, t6a, t6b, t6c now exist in working (dbtest) folder
t5a.ibd
t5b.ibd
t5c.ibd
t6a#p#p0.ibd
t6a#p#p1.ibd
t6b#p#p0.ibd
t6b#p#p1.ibd
t6c#p#p0.ibd
t6c#p#p1.ibd
# Restart the server
# restart: --innodb-directories=MYSQLTEST_VARDIR/innodb_directories;MYSQL_TMP_DIR/external_dir;MYSQL_TMP_DIR/external_dir2
# Alter table
ALTER TABLE dbtest.t1a FORCE;
ALTER TABLE dbtest.t1b FORCE, ALGORITHM=INPLACE;
ALTER TABLE dbtest.t1c FORCE, ALGORITHM=COPY;
ALTER TABLE dbtest.t2a FORCE;
ALTER TABLE dbtest.t2b FORCE, ALGORITHM=INPLACE;
ALTER TABLE dbtest.t2c FORCE, ALGORITHM=COPY;
ALTER TABLE dbtest.t3a FORCE;
ALTER TABLE dbtest.t3b FORCE, ALGORITHM=INPLACE;
ALTER TABLE dbtest.t3c FORCE, ALGORITHM=COPY;
ALTER TABLE dbtest.t4a FORCE;
ALTER TABLE dbtest.t4b FORCE, ALGORITHM=INPLACE;
ALTER TABLE dbtest.t4c FORCE, ALGORITHM=COPY;
ALTER TABLE dbtest.t5a FORCE;
ALTER TABLE dbtest.t5b FORCE, ALGORITHM=INPLACE;
ALTER TABLE dbtest.t5c FORCE, ALGORITHM=COPY;
ALTER TABLE dbtest.t6a FORCE;
ALTER TABLE dbtest.t6b FORCE, ALGORITHM=INPLACE;
ALTER TABLE dbtest.t6c FORCE, ALGORITHM=COPY;
# Check that the ibd files for t1a, t1b, t1c, t3a, t3b, t3c still exist in the innodb_directories folder
t1a.ibd
t1b.ibd
t1c.ibd
t3a#p#p0.ibd
t3a#p#p1.ibd
t3b#p#p0.ibd
t3b#p#p1.ibd
t3c#p#p0.ibd
t3c#p#p1.ibd
# Check that the ibd files for t1a, t1b, t1c, t3a, t3b, t3c do not exist and ibd files for t5a, t5b, t5c, t6a, t6b, t6c exist in the data directory folder
t5a.ibd
t5b.ibd
t5c.ibd
t6a#p#p0.ibd
t6a#p#p1.ibd
t6b#p#p0.ibd
t6b#p#p1.ibd
t6c#p#p0.ibd
t6c#p#p1.ibd
# Check that the ibd files for t5a, t5b, t5c, t6a, t6b, t6c do not exist in external directory2 where the tables are created
# Check that the ibd files for t2a, t2b, t2c, t4a, t4b, t4c still exist in the external directory where the tables are created
t2a.ibd
t2b.ibd
t2c.ibd
t4a#p#p0.ibd
t4a#p#p1.ibd
t4b#p#p0.ibd
t4b#p#p1.ibd
t4c#p#p0.ibd
t4c#p#p1.ibd
# Shutdown server
# Now move ibd files for t1a, t1b, t1c, t3a, t3b, t3c from innodb_directories folder to default directory
# Restart the server
# restart: --innodb-directories=MYSQLTEST_VARDIR/innodb_directories;MYSQL_TMP_DIR/external_dir;MYSQL_TMP_DIR/external_dir2
# Alter table
ALTER TABLE dbtest.t1a FORCE;
ALTER TABLE dbtest.t1b FORCE, ALGORITHM=INPLACE;
ALTER TABLE dbtest.t1c FORCE, ALGORITHM=COPY;
ALTER TABLE dbtest.t3a FORCE;
ALTER TABLE dbtest.t3b FORCE, ALGORITHM=INPLACE;
ALTER TABLE dbtest.t3c FORCE, ALGORITHM=COPY;
# Check ibd files for t1a, t1b, t1c, t3a, t3b, t3c exist in default directory
t1a.ibd
t1b.ibd
t1c.ibd
t3a#p#p0.ibd
t3a#p#p1.ibd
t3b#p#p0.ibd
t3b#p#p1.ibd
t3c#p#p0.ibd
t3c#p#p1.ibd
t5a.ibd
t5b.ibd
t5c.ibd
t6a#p#p0.ibd
t6a#p#p1.ibd
t6b#p#p0.ibd
t6b#p#p1.ibd
t6c#p#p0.ibd
t6c#p#p1.ibd
# Check ibd files for t1a, t1b, t1c, t3a, t3b, t3c do not exist in innodb_directories
# Clean Up
# Drop tables and database
DROP TABLE dbtest.t1a;
DROP TABLE dbtest.t1b;
DROP TABLE dbtest.t1c;
DROP TABLE dbtest.t2a;
DROP TABLE dbtest.t2b;
DROP TABLE dbtest.t2c;
DROP TABLE dbtest.t3a;
DROP TABLE dbtest.t3b;
DROP TABLE dbtest.t3c;
DROP TABLE dbtest.t4a;
DROP TABLE dbtest.t4b;
DROP TABLE dbtest.t4c;
DROP TABLE dbtest.t5a;
DROP TABLE dbtest.t5b;
DROP TABLE dbtest.t5c;
DROP TABLE dbtest.t6a;
DROP TABLE dbtest.t6b;
DROP TABLE dbtest.t6c;
DROP DATABASE dbtest;
# restart: 
# End Test
