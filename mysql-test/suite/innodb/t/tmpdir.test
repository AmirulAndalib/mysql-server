--source include/have_innodb.inc
--source include/count_sessions.inc

--echo #
--echo # Bug #19183565 CREATE DYNAMIC INNODB_TMPDIR VARIABLE TO CONTROL
--echo #		WHERE INNODB WRITES TEMP FILES
--echo #

create table t480(a serial)engine=innodb;
insert into t480
values(),(),(),(),(),(),(),(),(),(),(),(),(),(),(),(),(),(),(),(),(),(),
(),(),(),(),(),(),(),();
insert into t480 select 0 from t480;
insert into t480 select 0 from t480;
insert into t480 select 0 from t480;
insert into t480 select 0 from t480;

--echo # If innodb_tmpdir is NULL or "", temporary file will be created in
--echo # server configuration variable location(--tmpdir)

create table t1(f1 int auto_increment not null,
		f2 char(200) not null, f3 char(200) not null,
		primary key(f1,f2,f3), key(f1))engine=innodb;
insert into t1 select NULL,'aaa','bbb' from t480;
insert into t1 select NULL,'aaaa','bbbb' from t480;
insert into t1 select NULL,'aaaaa','bbbbb' from t480;
insert into t1 select NULL,'aaaaaa','bbbbbb' from t480;
show session variables like 'innodb_tmpdir';
alter table t1 drop primary key,add primary key(f2,f1);
set global innodb_tmpdir=NULL;
--echo # Connection con1
connect (con1,localhost,root);
show session variables like 'innodb_tmpdir';
alter table t1 drop primary key,add primary key(f3,f1);
connection default;
disconnect con1;
drop table t1;

--echo # Alter table fails due to invalid location specified in innodb_tmpdir.

create table t1(f1 int auto_increment not null,
		f2 char(200) not null, f3 char(200) not null,
		primary key(f1,f2,f3), key(f1))engine=innodb;
insert into t1 select NULL,'aaa','bbb' from t480;
insert into t1 select NULL,'aaaa','bbbb' from t480;
insert into t1 select NULL,'aaaaa','bbbbb' from t480;
insert into t1 select NULL,'aaaaaa','bbbbbb' from t480;
set global innodb_tmpdir='wrong_value';
show session variables like 'innodb_tmpdir';
--echo # Connection con2
connect (con2,localhost,root);
show session variables like 'innodb_tmpdir';
call mtr.add_suppression("\\[ERROR\\] InnoDB: Cannot create temporary merge file");
--replace_regex /wrong_value\/[A-Za-z0-9_]*//
--error 1, 1041
alter table t1 drop primary key,add primary key(f2,f1);
disconnect con2;
connection default;
set global innodb_tmpdir=NULL;
drop table t1;

--echo # innodb_tmpdir with valid location.

create table t1(f1 int auto_increment not null,
		f2 char(200) not null, f3 char(200) not null,
		primary key(f1,f2,f3),  key(f1))engine=innodb;
insert into t1 select NULL,'aaa','bbb' from t480;
insert into t1 select NULL,'aaaa','bbbb' from t480;
insert into t1 select NULL,'aaaaa','bbbbb' from t480;
insert into t1 select NULL,'aaaaaa','bbbbbb' from t480;
let $mysql_tmpdir = `select @@global.tmpdir`;
set global innodb_tmpdir = @@global.tmpdir;
show session variables like 'innodb_tmpdir';
--echo # Connection con3
connect (con3,localhost,root);
--replace_result $mysql_tmpdir tmpdir
show session variables like 'innodb_tmpdir';
alter table t1 add fulltext(f2);
disconnect con3;
connection default;
set global innodb_tmpdir=NULL;
drop table t1;
drop table t480;
--source include/wait_until_count_sessions.inc
