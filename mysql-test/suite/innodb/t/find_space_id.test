--source include/have_innodb.inc
--source include/not_embedded.inc

--echo #
--echo # Bug#20382921 INNODB ASSERT "!IS_COMPRESSED || PHYSICAL <= (1 << 14)" IN FIND_SPACE_ID
--echo #

--disable_query_log
call mtr.add_suppression("InnoDB: Header page consists of zero bytes");
call mtr.add_suppression("InnoDB: Datafile \'test/t1\' is corrupted");
call mtr.add_suppression("InnoDB: Tablespace [0-9]+ was not found");
--enable_query_log

let INNODB_PAGE_SIZE=`select @@innodb_page_size`;
let MYSQLD_DATADIR=`select @@datadir`;

create table t1 (f1 int primary key) engine=innodb;

begin;
insert into t1 values(1);
--source include/kill_mysqld.inc

--copy_file $MYSQLD_DATADIR/test/t1.ibd $MYSQLD_DATADIR/test/t1.ibd.bak

--echo # Make the first page (page_no=0) of the user tablespace
--echo # full of zeroes.
perl;
my $fname= "$ENV{'MYSQLD_DATADIR'}test/t1.ibd";
open(FILE, "+<", $fname) or die;
binmode FILE;
print FILE chr(0) x ($ENV{'INNODB_PAGE_SIZE'});
close FILE;
EOF

let $restart_parameters = restart: --innodb-force-recovery=1;
--source include/start_mysqld.inc

# we need to restore t1.ibd file first, then drop t1.
--source include/shutdown_mysqld.inc

--remove_file $MYSQLD_DATADIR/test/t1.ibd
--move_file $MYSQLD_DATADIR/test/t1.ibd.bak $MYSQLD_DATADIR/test/t1.ibd

let $restart_parameters = restart;
--source include/start_mysqld.inc

drop table t1;
