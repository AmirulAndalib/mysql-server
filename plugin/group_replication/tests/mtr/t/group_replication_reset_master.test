# This test intends to prove that members can survive reset master commands.
# These commands end up causing the members to purge their relay logs

--source include/have_group_replication_plugin.inc

--let $group_replication_group_name= c90c3c80-fde4-11e3-a3ac-0800200c9a66
--let $rpl_skip_group_replication_start= 1
--source include/master-slave.inc

--connection server1
--echo #Test a reset command before start.
RESET MASTER;

--source include/start_group_replication.inc

--connection server2
--source include/start_group_replication.inc

--echo #Create a table and insert some data
--connection server1
CREATE TABLE t1 (c1 INT NOT NULL PRIMARY KEY) ENGINE=InnoDB;

--let $sync_slave_connection= server2
--source include/sync_slave_sql_with_master.inc

--connection server2
INSERT INTO t1 VALUES (1);

--connection server1
INSERT INTO t1 VALUES (2);

--let $sync_slave_connection=server2
--source include/sync_slave_sql_with_master.inc

--connection server2
INSERT INTO t1 VALUES (3);

--let $sync_slave_connection=server1
--source include/sync_slave_sql_with_master.inc

--echo #Both members must have the same GTID set
--let $server_count=2
while ($server_count)
{
  --connection server$server_count
  --let $assert_text= On member $server_count, all executed GTID should belong to the group
  --let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "c90c3c80-fde4-11e3-a3ac-0800200c9a66:1-4";
  --source include/assert.inc
  --dec $server_count
}

--echo #Stop and reset both members

--connection server1
--source include/stop_group_replication.inc
RESET MASTER;

--connection server2
--source include/stop_group_replication.inc
RESET MASTER;

--echo #Restart both members

--source include/start_group_replication.inc

--connection server1

--source include/start_group_replication.inc

--echo #Both members must have an empty gtid set
--let $server_count=2
while ($server_count)
{
  --connection server$server_count
  --let $assert_text= On member $server_count, there should be no executed GTIDs
  --let $assert_cond= "[SELECT @@GLOBAL.GTID_EXECUTED]" = "";
  --source include/assert.inc
  --dec $server_count
}

--echo #Insert some data to test that the group is still running

INSERT INTO t1 VALUES (4);
--let $sync_slave_connection=server2
--source include/sync_slave_sql_with_master.inc

INSERT INTO t1 VALUES (5);
--let $sync_slave_connection=server1
--source include/sync_slave_sql_with_master.inc

--let $server_count=2
while ($server_count)
{
  --connection server$server_count
  --let $assert_text= On member $server_count, the table should exist and have 5 elements
  --let $assert_cond= [select count(*) from t1] = 5;
  --source include/assert.inc
  --dec $server_count
}

DROP TABLE t1;
--source include/rpl_end.inc
